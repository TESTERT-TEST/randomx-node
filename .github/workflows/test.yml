name: Build and Test RandomX Module

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository with submodules
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          python2.7 \
          pkg-config \
          gcc-8 \
          g++-8

    - name: Setup Node.js 10
      uses: actions/setup-node@v4
      with:
        node-version: '10.24.1'

    - name: Install compatible build tools
      run: |
        npm install -g node-gyp@5.1.0
        npm install nan@2.14.2 bindings@1.5.0

    - name: Set compatible compiler
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-8 800
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-8 800

    - name: Build RandomX as static library
      run: |
        cd randomx
        mkdir -p build
        cd build
        cmake -DARCH=native -DSTATIC_LIBRARY=ON ..
        make -j$(nproc)
        cd ../..

    - name: Build native module
      run: |
        export CXXFLAGS="-I$(pwd)/randomx/src -I$(pwd)/randomx/src/blake2"
        export LDFLAGS="-L$(pwd)/randomx/build"
        node-gyp configure
        node-gyp build
        ls -la build/Release/
        file build/Release/randomxhash.node

    - name: Run tests
      run: node test.js
